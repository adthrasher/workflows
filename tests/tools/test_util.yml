
- name: download_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
    miniwdl run -d test-output/. -i tests/tools/input_json/util_download.json --task download tools/util.wdl
  stdout:
    contains_regex:
      - '"download.downloaded_file": ".*test-output/out/downloaded_file/license.txt"'
  files:
    - path: test-output/out/downloaded_file/license.txt
      md5sum: cf3575bd84ab3151c7e9700b5f1a9746
      contains:
        - "MIT License"

- name: get_read_groups_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
    miniwdl run --verbose -d test-output/. -i tests/tools/input_json/util_get_read_groups.json --task get_read_groups --copy-input-files tools/util.wdl
  files:
    - path: test-output/out/read_groups_file/read_groups.txt
      contains:
        - "@RG	ID:1"
        - "@RG	ID:2"
      must_not_contain:
        - "@RG	ID:3"

- name: split_string_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
        miniwdl run -d test-output/. --task split_string tools/util.wdl input_string="rg1 , rg2"
  stdout:
    contains:
      - "rg1"
      - "rg2"
    must_not_contain:
      - "rg1 , rg2"

# TODO: Finish implementation
- name: calc_gene_lengths_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
    miniwdl run -d test-output/. --task calc_gene_lengths tools/util.wdl gtf="tests/tools/input/genes.gtf.gz"
  files:
    - path: test-output/out/gene_lengths/genes.genelengths.txt
      contains:
        - "AL954722.1"

# TODO: Implement qc_summary test
#- name: qc_summary_miniwdl
#  tags:
#    - miniwdl
#    - util
#  command: >-
#    miniwdl run -d test-output/. --task qc_summary --copy-input-files tools/util.wdl multiqc_tar_gz=""

- name: compression_integrity_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
    miniwdl run -d test-output/. --task compression_integrity --copy-input-files tools/util.wdl bam="https://github.com/stjude/CICERO/raw/master/test/data/input/test.bam"
  stdout:
    contains:
      - "passed"

- name: add_to_bam_header_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
      miniwdl run -d test-output/. --task add_to_bam_header --copy-input-files tools/util.wdl bam="https://github.com/stjude/CICERO/raw/master/test/data/input/test.bam" additional_header="@RG	ID:3"
  files:
    - path: "test-output/out/reheadered_bam/test.reheader.bam"
  stdout:
    contains:
      - "@RG\\tID:3"

- name: unpack_tarball_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
      miniwdl run -d test-output/. --task unpack_tarball --copy-input-files tools/util.wdl tarball="tests/tools/input/test.tar.gz"
  files:
    - path: "test-output/out/tarball_contents/2/a"
    - path: "test-output/out/tarball_contents/3/b"

- name: make_coverage_regions_beds_miniwdl
  tags:
    - miniwdl
    - util
  command: >-
    miniwdl run -d test-output/. --task make_coverage_regions_beds --copy-input-files tools/util.wdl gtf="tests/tools/input/genes.gtf.gz"
  files:
    - path: "test-output/out/bed/genes.gtf.bed"
    - path: "test-output/out/exon_bed/genes.gtf.exon.bed"
    - path: "test-output/out/CDS_bed/genes.gtf.CDS.bed"